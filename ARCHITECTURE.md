# OASIS AI - Production Architecture & Supabase Integration Guide

## 1. System Overview

OASIS AI uses a **distributed architecture** where data flows securely between three main components:
1. **The Client Portal (Vercel)**: The dashboard where clients view their bots.
2. **Supabase (Database)**: The "Single Source of Truth" storing all users, bots, and logs.
3. **The AI Engine (n8n)**: The automation workflows that execute tasks and report back.

## 2. Data Congruency Model (How everything connects)

To ensure "Production Grade" data integrity, we follow the **UUID Linkage Principle**.

### A. The User (Identity)
- Every client has a unique `User ID` (UUID) generated by Supabase Auth upon signup.
- This ID is the "Key" to everything.
- **Table**: `auth.users` (managed by Supabase) & `public.profiles` (our data).

### B. The Automation (The Asset)
- Every bot belongs to exactly one user.
- **Table**: `client_automations`
- **Link**: `user_id` column points to the User UUID.
- **Identity**: Each automation ALSO has its own unique `Automation ID`.
- **CRITICAL**: This `Automation ID` is what n8n uses to know "Who am I?" and "Who is my owner?".

### C. The Logs (The Proof)
- When n8n runs, it generates a log.
- **Table**: `automation_logs`
- **Link**: Points to `Automation ID` (so we know which bot did it) and `User ID` (so we know who to bill/show).

## 3. Production Security & Isolation (RLS)

We use **Row Level Security (RLS)** to enforce strict isolation.
- **Rule**: `SELECT * FROM table WHERE user_id = auth.uid()`
- **Result**: Even if a hacker queries the database, they get 0 rows unless they are logged in as that specific client.
- **Production Grade**: This is enabled on ALL tables (`profiles`, `client_automations`, `automation_logs`).

## 4. Master Setup & Repair Script

If data ever gets "messed up" (e.g. n8n sending to wrong ID), run this Master SQL script in Supabase to re-align everything.

### STEP 1: Get Your User ID
Run this in Supabase SQL Editor:
```sql
SELECT id, email FROM auth.users WHERE email = 'your-email@example.com';
```
*Copy the ID returned (e.g., `7cfe109c-...`)*

### STEP 2: create/Repair Your Automation
Replace `YOUR_USER_ID_HERE` with the ID from Step 1.

```sql
-- 1. Ensure Profile Exists
INSERT INTO public.profiles (id, email, full_name, company_name)
VALUES ('YOUR_USER_ID_HERE', 'your-email@example.com', 'Admin User', 'OASIS HQ')
ON CONFLICT (id) DO NOTHING;

-- 2. Create the Customer Support Agent (if missing)
INSERT INTO public.client_automations (user_id, automation_type, display_name, status, tier)
SELECT 'YOUR_USER_ID_HERE', 'support_bot', 'Customer Support Agent', 'active', 'enterprise'
WHERE NOT EXISTS (
    SELECT 1 FROM public.client_automations 
    WHERE user_id = 'YOUR_USER_ID_HERE' AND automation_type = 'support_bot'
);

-- 3. GET THE AUTOMATION ID FOR n8n
SELECT id, display_name FROM public.client_automations WHERE user_id = 'YOUR_USER_ID_HERE';
```

### STEP 3: Connect n8n
1. Take the **Automation ID** from the query above.
2. Go to your n8n workflow.
3. Open the HTTP Request node that calls your API.
4. Set the `automation_id` field to this ID.

## 5. Deployment Checklist
- [x] **Frontend**: Pages for Automations, Reports, Billing created.
- [x] **Backend API**: `/api/n8n/log` enforces API Key security.
- [x] **Database**: RLS policies active.
- [x] **Data Flow**: n8n -> API -> Supabase -> Dashboard verified.
